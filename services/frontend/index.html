<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Recherche S√©mantique M√©dicale</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 40px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        h1 { 
            color: #2c3e50; 
            text-align: center; 
            margin-bottom: 30px; 
        }
        .section { 
            margin: 30px 0; 
            padding: 20px; 
            background: #f8f9fa; 
            border-radius: 8px; 
            border-left: 4px solid #007bff; 
        }
        .upload-section { border-left-color: #28a745; }
        .search-section { border-left-color: #007bff; }
        .stats-section { border-left-color: #17a2b8; }
        input, button, select, textarea { 
            padding: 10px; 
            margin: 5px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        button { 
            background: #007bff; 
            color: white; 
            cursor: pointer; 
            border: none; 
            font-weight: 600; 
        }
        button:hover { background: #0056b3; }
        button:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        .result { 
            margin: 15px 0; 
            padding: 20px; 
            background: white; 
            border-left: 4px solid #007bff; 
            border-radius: 5px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        }
        .result h4 { 
            margin: 0 0 10px 0; 
            color: #495057; 
        }
        .result .scores { 
            font-size: 0.9em; 
            color: #6c757d; 
            margin: 10px 0; 
        }
        .result .snippet { 
            line-height: 1.6; 
            color: #495057; 
        }
        .result .meta { 
            font-size: 0.8em; 
            color: #6c757d; 
            margin-top: 10px; 
            border-top: 1px solid #eee; 
            padding-top: 10px; 
        }
        #results { margin-top: 20px; }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
        }
        .status.success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .status.error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .status.info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb; 
        }
        .search-options { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin: 15px 0; 
        }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 15px; 
            margin: 15px 0; 
        }
        .stat-card { 
            background: white; 
            padding: 15px; 
            text-align: center; 
            border-radius: 5px; 
            border: 1px solid #dee2e6; 
        }
        .stat-number { 
            font-size: 1.5em; 
            font-weight: bold; 
            color: #007bff; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè• Recherche S√©mantique M√©dicale</h1>
        <p style="text-align: center; color: #6c757d; margin-bottom: 30px;">
            Pipeline de recherche hybride avec IA pour documents m√©dicaux
        </p>
        
        <div class="section upload-section">
            <h2>üìÑ Upload de Document</h2>
            <div>
                <input type="file" id="fileInput" accept=".txt,.pdf" />
                <button onclick="uploadFile()">Uploader</button>
                <button onclick="uploadSampleDoc()">Tester avec document exemple</button>
            </div>
            <div id="uploadStatus"></div>
        </div>

        <div class="section search-section">
            <h2>üîç Recherche Intelligente</h2>
            <div>
                <input type="text" id="searchInput" placeholder="Ex: douleur thoracique, diagnostic diff√©rentiel..." style="width: 60%;">
                <button onclick="search()">Rechercher</button>
            </div>
            
            <div class="search-options">
                <div>
                    <label>Type de recherche:</label>
                    <select id="searchType">
                        <option value="hybrid">Hybride (Textuel + S√©mantique)</option>
                        <option value="textual">Textuel uniquement</option>
                        <option value="semantic">S√©mantique uniquement</option>
                    </select>
                </div>
                <div>
                    <label>Limite de r√©sultats:</label>
                    <select id="searchLimit">
                        <option value="5">5 r√©sultats</option>
                        <option value="10" selected>10 r√©sultats</option>
                        <option value="20">20 r√©sultats</option>
                    </select>
                </div>
            </div>
            
            <div style="margin: 15px 0;">
                <button onclick="testSearch()">Test: douleur thoracique</button>
                <button onclick="testSearchHybrid()">Test: cardiologie (hybride)</button>
                <button onclick="debugEmbeddings()">Debug embeddings</button>
            </div>
            
            <div id="results"></div>
        </div>
        
        <div class="section stats-section">
            <h2>üìä Statistiques du Syst√®me</h2>
            <button onclick="loadStats()">Actualiser les statistiques</button>
            <div id="stats" class="stats-grid"></div>
        </div>
    </div>

    <script>
        // Configuration des URLs
        const API_BASE = window.location.protocol + "//" + window.location.hostname + ":8000";
        const PROCESSING_BASE = window.location.protocol + "//" + window.location.hostname + ":8001";
        
        console.log("URLs configur√©es:", { API_BASE, PROCESSING_BASE });

        function showStatus(message, type = "info") {
            const statusDiv = document.getElementById("uploadStatus");
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function uploadFile() {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];
            if (!file) {
                showStatus("Veuillez s√©lectionner un fichier", "error");
                return;
            }

            const formData = new FormData();
            formData.append("file", file);
            showStatus("Upload en cours...", "info");

            try {
                const response = await fetch(`${PROCESSING_BASE}/upload`, {
                    method: "POST",
                    body: formData
                });
                
                const result = await response.json();
                if (response.ok && result.status === "success") {
                    showStatus(`‚úÖ Document trait√© avec succ√®s!<br>
                        ID: ${result.document_id}<br>
                        Phrases trait√©es: ${result.sentences_processed}`, "success");
                    loadStats(); // Actualiser les stats
                } else {
                    showStatus(`‚ùå Erreur: ${result.error || "Erreur inconnue"}`, "error");
                }
            } catch (error) {
                showStatus(`‚ùå Erreur de connexion: ${error.message}`, "error");
                console.error("Erreur upload:", error);
            }
        }

        async function uploadSampleDoc() {
            const sampleDoc = `PATIENT: Test Patient, 45 ans

MOTIF DE CONSULTATION:
Douleur thoracique atypique

HISTOIRE DE LA MALADIE:
Douleur thoracique intermittente depuis 1 semaine
Pas de facteur d√©clenchant identifi√©
Am√©lioration partielle au repos

ANT√âC√âDENTS:
- Pas d'ant√©c√©dent cardiovasculaire
- Stress professionnel r√©cent

EXAMEN CLINIQUE:
TA: 130/80 mmHg, FC: 75/min
Auscultation cardiaque et pulmonaire normale

DIAGNOSTIC:
Douleur thoracique atypique, probablement musculo-squelettique
Pas de signe d'urgence cardiologique

TRAITEMENT:
Anti-inflammatoire local
Repos relatif
Contr√¥le si persistance`;

            const blob = new Blob([sampleDoc], { type: "text/plain" });
            const formData = new FormData();
            formData.append("file", blob, "exemple_medical.txt");
            
            showStatus("Upload du document exemple en cours...", "info");

            try {
                const response = await fetch(`${PROCESSING_BASE}/upload`, {
                    method: "POST",
                    body: formData
                });
                
                const result = await response.json();
                if (response.ok && result.status === "success") {
                    showStatus(`‚úÖ Document exemple trait√©!<br>
                        ID: ${result.document_id}<br>
                        Phrases: ${result.sentences_processed}`, "success");
                    loadStats();
                } else {
                    showStatus(`‚ùå Erreur: ${result.error}`, "error");
                }
            } catch (error) {
                showStatus(`‚ùå Erreur: ${error.message}`, "error");
            }
        }

        async function search() {
            const query = document.getElementById("searchInput").value;
            const searchType = document.getElementById("searchType").value;
            const limit = parseInt(document.getElementById("searchLimit").value);
            
            if (!query.trim()) {
                alert("Veuillez saisir une requ√™te");
                return;
            }

            document.getElementById("results").innerHTML = "<div class=\"status info\">Recherche en cours...</div>";

            try {
                const response = await fetch(`${API_BASE}/search`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        query: query,
                        search_type: searchType,
                        limit: limit
                    })
                });

                const results = await response.json();
                displayResults(results, query);
            } catch (error) {
                document.getElementById("results").innerHTML = 
                    `<div class="status error">‚ùå Erreur de recherche: ${error.message}</div>`;
                console.error("Erreur recherche:", error);
            }
        }

        function displayResults(results, query) {
            const resultsDiv = document.getElementById("results");
            
            if (!results || results.length === 0) {
                resultsDiv.innerHTML = "<div class=\"status info\">Aucun r√©sultat trouv√©</div>";
                return;
            }

            let html = `<h3>üìã ${results.length} r√©sultat(s) trouv√©(s) pour "${query}"</h3>`;
            
            results.forEach((result, index) => {
                const score = result.hybrid_score || result.score || 0;
                const textualScore = result.relevance_score || 0;
                const semanticScore = result.semantic_score || 0;
                
                html += `
                    <div class="result">
                        <h4>${result.title || "Document " + (index + 1)}</h4>
                        <div class="scores">
                            <strong>Type:</strong> ${result.type || "N/A"} | 
                            <strong>Score:</strong> ${score.toFixed(3)}
                            ${result.type === "hybrid" ? 
                                ` (Textuel: ${textualScore.toFixed(3)}, S√©mantique: ${semanticScore.toFixed(3)})` 
                                : ""}
                        </div>
                        <div class="snippet">${result.snippet || result.content?.substring(0, 300) + "..."}</div>
                        <div class="meta">
                            <strong>ID:</strong> ${result.document_id} | 
                            <strong>Taille:</strong> ${result.content?.length || 0} caract√®res
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }

        async function testSearch() {
            document.getElementById("searchInput").value = "douleur thoracique";
            document.getElementById("searchType").value = "textual";
            await search();
        }

        async function testSearchHybrid() {
            document.getElementById("searchInput").value = "cardiologie";
            document.getElementById("searchType").value = "hybrid";
            await search();
        }

        async function debugEmbeddings() {
            try {
                const response = await fetch(`${API_BASE}/debug/embeddings`);
                const debug = await response.json();
                
                document.getElementById("results").innerHTML = `
                    <h3>üîß Debug Embeddings</h3>
                    <div class="result">
                        <h4>Informations sur les embeddings stock√©s</h4>
                        <div class="snippet">
                            <strong>Total embeddings:</strong> ${debug.total_embeddings}<br><br>
                            <strong>√âchantillon:</strong><br>
                            ${debug.sample_embeddings?.map(emb => 
                                `‚Ä¢ Doc: ${emb.document_id.substring(0, 8)}... | 
                                 Taille: ${emb.embedding_size} | 
                                 Contenu: ${emb.content}...`
                            ).join("<br>") || "Aucun √©chantillon"}
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById("results").innerHTML = 
                    `<div class="status error">Erreur debug: ${error.message}</div>`;
            }
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const stats = await response.json();
                
                document.getElementById("stats").innerHTML = `
                    <div class="stat-card">
                        <div>Documents index√©s</div>
                        <div class="stat-number">${stats.indexed_documents || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div>Documents uniques</div>
                        <div class="stat-number">${stats.unique_documents || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div>Embeddings totaux</div>
                        <div class="stat-number">${stats.total_embeddings || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div>Taille index</div>
                        <div class="stat-number">${stats.index_size || 0} MB</div>
                    </div>
                `;
            } catch (error) {
                document.getElementById("stats").innerHTML = 
                    `<div class="status error">Erreur chargement stats: ${error.message}</div>`;
            }
        }

        // Test de connectivit√© au d√©marrage
        window.onload = function() {
            loadStats();
            
            // Test APIs
            Promise.all([
                fetch(`${API_BASE}/health`).then(r => r.json()),
                fetch(`${PROCESSING_BASE}/health`).then(r => r.json())
            ])
            .then(([searchHealth, processHealth]) => {
                console.log("APIs connect√©es:", { searchHealth, processHealth });
                showStatus(`‚úÖ Services connect√©s: ${searchHealth.service} + ${processHealth.service}`, "success");
            })
            .catch(error => {
                console.warn("Probl√®me de connectivit√©:", error);
                showStatus(`‚ö†Ô∏è Probl√®me de connectivit√© avec les APIs`, "error");
            });
        };
    </script>
</body>
</html>